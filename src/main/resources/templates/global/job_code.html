<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>직급/직책 선택</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; }
        .grid { display: flex; gap: 20px; }
        select { min-width: 240px; padding: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
        button { margin-top: 20px; padding: 6px 12px; }
    </style>
</head>
<body>
<h3>직급 / 직책 선택</h3>

<div class="grid">
    <!-- 왼쪽: 직책 (선택) -->
    <div>
        <label for="positionSelect">직급</label><br>
        <select id="positionSelect" size="10"></select>
    </div>

    <!-- 오른쪽: 직급 (선택) -->
    <div>
        <label for="rankSelect">직책</label><br>
        <select id="rankSelect" size="10"></select>
    </div>
</div>

<button type="button" onclick="applySelection()">선택</button>

<script>
    function makeOptionText(item) {
      const code = item.code ?? '';
      const kor  = item.korName ?? '';
      const eng  = item.engName ?? '';
      return `[${code}] ${kor} / ${eng}`;
    }
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${url} ${res.status}`);
      return res.json();
    }

    // 직책(선택)
    fetchJson('/global/jobcode/positions')
      .then(list => {
        const sel = document.getElementById('positionSelect');
        sel.innerHTML = '';
        (list || []).forEach(item => {
          const opt = document.createElement('option');
          // 부모로는 한국어명 전달 (VARCHAR(4) 대응)
          opt.value = item.korName;
          opt.dataset.kor = item.korName;
          opt.textContent = makeOptionText(item);
          sel.appendChild(opt);
        });
      })
      .catch(err => console.warn('직책 로드 실패:', err));

    // 직급(선택)
    fetchJson('/global/jobcode/ranks')
      .then(list => {
        const sel = document.getElementById('rankSelect');
        sel.innerHTML = '';
        (list || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.korName;
          opt.dataset.kor = item.korName;
          opt.textContent = makeOptionText(item);
          sel.appendChild(opt);
        });
      })
      .catch(err => console.warn('직급 로드 실패:', err));

 function normalizeKor(value){
    return (value && value.trim() === '의과대학생') ? '대학생' : value;
  }

  function applySelection() {
    const rankOpt = document.getElementById('rankSelect').selectedOptions[0];
    const posOpt  = document.getElementById('positionSelect').selectedOptions[0];

    let rankKor     = rankOpt ? (rankOpt.dataset.kor || rankOpt.value) : '';
    let positionKor = posOpt  ? (posOpt.dataset.kor  || posOpt.value)  : '';

    // ✅ 오직 "의과대학생"만 대학생으로 치환
    rankKor     = normalizeKor(rankKor);
    positionKor = normalizeKor(positionKor);

    window.opener?.postMessage({
      source: 'jobcode-popup',
      payload: { rankCode: rankKor, positionCode: positionKor }
    }, '*');

    window.close();
  }
</script>
</body>
</html>
