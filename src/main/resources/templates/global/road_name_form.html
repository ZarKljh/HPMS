<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>도로명 주소 검색</title>

    <!-- Bootstrap -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
            crossorigin="anonymous">

    <!-- 공통 CSS -->
    <link rel="stylesheet" type="text/css" th:href="@{/CSS/doctor/doctor.css}">

    <style>
        .popup-container.container { width:auto !important; max-width:980px; padding:12px 16px; }
        .sub_title { font-size:14px; color:#6c757d; }
        .form-control:focus, .button-link:focus, a:focus, input[type="text"]:focus {
          outline:none !important; box-shadow:none !important; border-color:#dee2e6 !important;
        }
        /* 도로명(한)만 호버 시 밑줄 */
        .name_hover { text-decoration: none; color: inherit; }
        .name_hover:hover { text-decoration: underline; }

        /* 페이지 네비 */
        .pagination a:hover { text-decoration: underline; }
    </style>
</head>
<body>
<div class="container popup-container">
    <h2 class="listbox">도로명 주소 검색 <span class="sub_title">Road Name Finder</span></h2>

    <!-- 검색 -->
    <form id="searchForm" class="d-flex align-items-center" onsubmit="doSearch(0); return false;">
        <div class="search_box row my-3" style="width:100%;">
            <div style="width:100%;">
                <div class="input-group">
                    <input type="text" id="kw" class="form-control" placeholder="시/군/구/읍면동/도로명/코드">
                    <a href="#" class="button-link" onclick="doSearch(0); return false;">검색</a>
                    <a href="#" class="button-link" onclick="document.getElementById('kw').value=''; doSearch(0); return false;">전체보기</a>
                </div>
            </div>
        </div>
    </form>

    <!-- 결과 -->
    <table class="table table-hover card chang-table-layout listTable">
        <thead class="table-light">
        <tr class="list text-center">
            <th>시도</th>
            <th>시군구</th>
            <th>읍면동</th>
            <th>도로명(한)</th>
            <th>도로코드</th>
        </tr>
        </thead>
        <tbody id="rows" class="text-center">
        <tr><td colspan="5" style="text-align:center;">검색어를 입력 후 검색을 눌러주세요.</td></tr>
        </tbody>
    </table>

    <!-- 페이징 -->
    <div class="pagination" style="justify-content:center; margin-top:12px;">
        <a href="#" id="prev" onclick="goPrev(); return false;" style="display:none;">이전</a>
        <span id="pageInfo" class="mx-2">0/0</span>
        <a href="#" id="next" onclick="goNext(); return false;" style="display:none;">다음</a>
    </div>

    <div class="d-flex justify-content-end" style="gap:10px; margin-top:12px;">
        <a href="javascript:void(0)" class="button-link" onclick="window.close()">창 닫기</a>
    </div>
</div>

<script>
    let currentPage = 0, totalPages = 0, pageSize = 10;

    function updatePager() {
      const prev = document.getElementById('prev');
      const next = document.getElementById('next');
      const info = document.getElementById('pageInfo');
      if (info) info.textContent = `${totalPages ? (currentPage+1) : 0}/${totalPages}`;
      if (prev) prev.style.display = (currentPage > 0) ? '' : 'none';
      if (next) next.style.display = (currentPage < totalPages - 1) ? '' : 'none';
    }
    function goPrev(){ if (currentPage > 0) load(currentPage - 1); }
    function goNext(){ if (currentPage < totalPages - 1) load(currentPage + 1); }

    function doSearch(page){ load(page ?? 0); }

    function load(page) {
      const kw = document.getElementById('kw').value || '';
      fetch(`/global/road/search?kw=${encodeURIComponent(kw)}&page=${page}&size=${pageSize}`)
        .then(r => r.json())
        .then(data => {
          currentPage = data.number || 0;
          totalPages  = data.totalPages || 0;
          updatePager();

          const tbody = document.getElementById('rows');
          tbody.innerHTML = '';
          const list = data.content || [];
          if (!list.length) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">결과가 없습니다.</td></tr>`;
            return;
          }

          list.forEach(a => {
            const sido = a.sido_kor ?? '';
            const sgg  = a.sgg_kor ?? '';
            const emd  = a.emd_kor ?? '';
            const road = a.road_name_kor ?? '';
            const code = a.road_code ?? '';
            const addrStr = [sido, sgg, emd, road].filter(Boolean).join(' ');

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${sido}</td>
              <td>${sgg}</td>
              <td>${emd}</td>
              <td><a href="#" class="name_hover">${road}</a></td>
              <td>${code}</td>
            `;
            // 도로명(한) 클릭 시만 선택 전송
            tr.querySelector('a.name_hover').addEventListener('click', (e) => {
              e.preventDefault();
              chooseRoad(addrStr, code, a.emd_seq_no || '');
            });
            tbody.appendChild(tr);
          });
        })
        .catch(e => {
          console.error(e);
          alert('검색 중 오류가 발생했습니다.');
        });
    }

    function chooseRoad(addrStr, roadCode, emdSeqNo) {
      try {
        if (window.opener && !window.opener.closed) {
          if (typeof window.opener.setRoad === 'function') {
            window.opener.setRoad(addrStr, roadCode || '', emdSeqNo || '');
          } else if (window.opener.postMessage) {
            window.opener.postMessage({ source:'road-popup', payload:{ addr: addrStr, roadCode, emdSeq: emdSeqNo } }, '*');
          }
        }
      } finally { window.close(); }
    }

    // URL의 kw가 있으면 반영 후 자동 조회
    (function initFromQuery(){
      const params = new URLSearchParams(location.search);
      const kw = params.get('kw');
      if (kw) {
        document.getElementById('kw').value = kw;
        doSearch(parseInt(params.get('page') || '0', 10) || 0);
      }
    })();
</script>
</body>
</html>
