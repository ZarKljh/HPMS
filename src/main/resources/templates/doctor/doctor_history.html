<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Doctor History</title>
  <style>
    body { font-family: sans-serif; }
    form.search { margin-bottom: 16px; display: grid; grid-template-columns: repeat(6, minmax(160px, 1fr)); gap: 8px; align-items: end; }
    form.search .full { grid-column: 1 / -1; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #fafafa; text-align: left; }
    .pager { margin-top: 12px; display: flex; gap: 8px; align-items: center; }
    .muted { color: #666; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>

<h2>의사 히스토리</h2>

<!-- 검색 폼 -->
<form class="search" th:action="@{/doctor/history}" method="get">
  <div>
    <label>시작일</label><br/>
    <input type="date" name="fromDate" th:value="${cond.fromDate}" />
  </div>

  <div>
    <label>종료일</label><br/>
    <input type="date" name="toDate" th:value="${cond.toDate}" />
  </div>

  <div>
    <label>키워드</label><br/>
    <input type="text" name="keyword" th:value="${cond.keyword}" placeholder="이름/부서/비고 등" />
  </div>

  <div class="full right">
    <label>페이지 크기</label>
    <select name="size">
      <option th:value="10"  th:selected="${page.size == 10}">10</option>
      <option th:value="20"  th:selected="${page.size == 20}">20</option>
      <option th:value="50"  th:selected="${page.size == 50}">50</option>
      <option th:value="100" th:selected="${page.size == 100}">100</option>
    </select>
    <input type="hidden" name="page" th:value="${page.number}" />
    <input type="hidden" name="sort" th:value="${param.sort != null ? param.sort[0] : 'createDate,DESC'}" />
    <button type="submit">검색</button>
    <a th:href="@{/doctor/history}">초기화</a>
  </div>
</form>

<!-- 정렬 헤더 계산 -->
<th:block th:with="
  sortParam=${param.sort != null ? param.sort[0] : 'createDate,DESC'},
  nextDateSort=${sortParam.startsWith('createDate') and sortParam.endsWith('ASC') ? 'createDate,DESC' : 'createDate,ASC'}
">

  <!-- 결과 테이블 -->
  <table>
    <thead>
    <tr>
      <th>ID</th>
      <th>Doctor ID</th>
      <th>
        <a th:href="@{/doctor/history(
              doctorId=${cond.doctorId},
              fromDate=${cond.fromDate},
              toDate=${cond.toDate},
              keyword=${cond.keyword},
              page=${page.number},
              size=${page.size},
              sort=${nextDateSort}
          )}">생성일</a>
        <span class="muted" th:text="${sortParam} == 'createDate,DESC' ? '▼' : (sortParam == 'createDate,ASC' ? '▲' : '')"></span>
      </th>
      <th>작성자</th>
      <th>이름</th>
      <th>부서 / 진료과</th>
      <th>전화</th>
      <th>입사일</th>
      <th>비고</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${page.totalElements == 0}">
      <td colspan="9" class="muted">데이터가 없습니다.</td>
    </tr>

    <tr th:each="h : ${page.content}">
      <td th:text="${h.id}"></td>
      <td class="nowrap" th:text="${h.doctorMain != null ? h.doctorMain.id : '-'}"></td>
      <td class="nowrap" th:text="${#temporals.format(h.createDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
      <td th:text="${h.writer}"></td>
      <td th:text="${(h.lastName != null ? h.lastName : '') + ' ' + (h.firstName != null ? h.firstName : '')}"></td>
      <td>
        <span th:text="${h.department}"></span>
        <span class="muted" th:if="${h.medicalDepartment != null}"> / </span>
        <span class="muted" th:text="${h.medicalDepartment}"></span>
      </td>
      <td th:text="${h.telephone}"></td>
      <td class="nowrap" th:text="${h.hireDate != null ? #temporals.format(h.hireDate, 'yyyy-MM-dd') : ''}"></td>
      <td th:text="${h.note}"></td>
    </tr>
    </tbody>
  </table>

  <!-- 페이징 -->
  <div class="pager">
    <span class="muted">
      페이지 <b th:text="${page.number + 1}"></b> / <span th:text="${page.totalPages}"></span>
      (총 <span th:text="${page.totalElements}"></span>건)
    </span>

    <a th:if="${!page.first}"
       th:href="@{/doctor/history(
           doctorId=${cond.doctorId},
           fromDate=${cond.fromDate},
           toDate=${cond.toDate},
           keyword=${cond.keyword},
           page=${0},
           size=${page.size},
           sort=${sortParam}
       )}">« 첫 페이지</a>

    <a th:if="${page.hasPrevious()}"
       th:href="@{/doctor/history(
           doctorId=${cond.doctorId},
           fromDate=${cond.fromDate},
           toDate=${cond.toDate},
           keyword=${cond.keyword},
           page=${page.number - 1},
           size=${page.size},
           sort=${sortParam}
       )}">‹ 이전</a>

    <a th:if="${page.hasNext()}"
       th:href="@{/doctor/history(
           doctorId=${cond.doctorId},
           fromDate=${cond.fromDate},
           toDate=${cond.toDate},
           keyword=${cond.keyword},
           page=${page.number + 1},
           size=${page.size},
           sort=${sortParam}
       )}">다음 ›</a>

    <a th:if="${!page.last}"
       th:href="@{/doctor/history(
           doctorId=${cond.doctorId},
           fromDate=${cond.fromDate},
           toDate=${cond.toDate},
           keyword=${cond.keyword},
           page=${page.totalPages - 1},
           size=${page.size},
           sort=${sortParam}
       )}">끝 페이지 »</a>
  </div>
</th:block>

</body>
</html>
