<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{doctor/doctor_layout}">

<div layout:fragment="content" class="container">
  <h2 class="listbox">Doctor History <span class="sub_title">의사 히스토리</span></h2>
  <p class="detail-subtitle">현재 등록된 의사의 히스토리 정보입니다.</p>

  <!-- ✅ 호버 스타일: 데이터 링크만 밑줄, 버튼형 링크는 밑줄 제거 -->


  <!-- 상단 좌우 바 (List와 동일한 배치) -->
  <div class="d-flex flex-wrap justify-content-between align-items-center">

    <!-- 좌: 건수/현재 페이지/페이지당 행수 -->
    <form method="get" action="/doctor/history" class="size_bar d-flex align-items-center mb-2 mb-md-0">
      <div class="d-flex align-items-center">
        <strong class="me-1">등록 건수:</strong>
        <span th:text="${page != null ? page.totalElements : 0}">0</span>건 /
        <strong class="mx-1">현재 페이지:</strong>
        <span th:text="${page != null ? page.number + 1 : 1}">1</span> /
        <strong class="mx-1">페이지당 행 수:</strong>
        <select name="size" id="size" onchange="this.form.submit();">
          <option th:value="10"  th:selected="${(page != null ? page.size : 10) == 10}">10</option>
          <option th:value="20"  th:selected="${(page != null ? page.size : 10) == 20}">20</option>
          <option th:value="50"  th:selected="${(page != null ? page.size : 10) == 50}">50</option>
          <option th:value="100" th:selected="${(page != null ? page.size : 10) == 100}">100</option>
        </select>

        <!-- 상태 유지용 히든 -->
        <input type="hidden" name="page"     th:value="${page != null ? page.number : 0}"/>
        <input type="hidden" name="sort"     th:value="${param.sort != null ? param.sort[0] : 'createDate,DESC'}"/>
        <input type="hidden" name="fromDate" th:value="${cond != null ? cond.fromDate : null}"/>
        <input type="hidden" name="toDate"   th:value="${cond != null ? cond.toDate   : null}"/>
        <input type="hidden" name="keyword"  th:value="${cond != null ? cond.keyword  : null}"/>
        <input type="hidden" name="doctorId" th:value="${cond != null ? cond.doctorId : null}"/>
      </div>
    </form>

    <!-- 우: 검색 (기간 + 키워드) -->
    <form method="get" action="/doctor/history" class="d-flex align-items-center">
      <div class="search_box row my-3">
        <div>
          <div class="input-group">
            <input type="date" class="form-control" name="fromDate" th:value="${cond != null ? cond.fromDate : null}"/>
            <input type="date" class="form-control" name="toDate"   th:value="${cond != null ? cond.toDate   : null}"/>
            <input type="text"  id="search_kw" name="keyword" class="form-control"
                   placeholder="이름/부서/비고 등" th:value="${cond != null ? cond.keyword : null}"/>
            <button class="search_btn" type="submit" id="btn_search">검색</button>
          </div>
        </div>

        <!-- 상태 유지용 히든 -->
        <input type="hidden" name="page"     th:value="${page != null ? page.number : 0}"/>
        <input type="hidden" name="size"     th:value="${page != null ? page.size : 10}"/>
        <input type="hidden" name="sort"     th:value="${param.sort != null ? param.sort[0] : 'createDate,DESC'}"/>
        <input type="hidden" name="doctorId" th:value="${cond != null ? cond.doctorId : null}"/>
      </div>
    </form>
  </div>

  <!-- 정렬 파라미터 계산 -->
  <th:block th:with="
      sortParam=${param.sort != null ? param.sort[0] : 'createDate,DESC'},
      sortLower=${#strings.toLowerCase(sortParam)},
      isAsc=${#strings.endsWith(sortLower,'asc')},
      nextDateSort=${isAsc} ? 'createDate,DESC' : 'createDate,ASC'
  ">

    <!-- 결과 테이블 -->
    <table class="table table-hover card">
      <thead class="table-light">
      <tr class="list text-center">
        <th>
          <a th:href="@{/doctor/history(
              doctorId=${cond != null ? cond.doctorId : null},
              fromDate=${cond != null ? cond.fromDate : null},
              toDate=${cond != null ? cond.toDate : null},
              keyword=${cond != null ? cond.keyword : null},
              page=${page != null ? page.number : 0},
              size=${page != null ? page.size : 10},
              sort=${nextDateSort}
          )}">생성일</a>
          <span class="muted" th:text="${isAsc} ? '▲' : '▼'"></span>
        </th>
        <th>수정자</th>
        <th>성명</th>
        <th>상태</th>
      </tr>
      </thead>

      <tbody class="text-center">
      <tr th:if="${page == null or page.totalElements == 0}">
        <td colspan="13" class="muted">데이터가 없습니다.</td>
      </tr>

      <tr th:each="h : ${page != null ? page.content : {}}">
        <td class="nowrap">
          <a th:text="${h.createDate != null ? #temporals.format(h.createDate, 'yyyy-MM-dd HH:mm:ss') : ''}">-</a>
        </td>
        <td><a  th:text="${h.writer}">-</a></td>
        <td><a th:href="@{/doctor/history/{hid}(hid=${h.id})}" th:text="${h.lastName +' '+(h.middleName != null ? h.middleName +' ' : ' ')+h.firstName}">-</a></td>
        <td><a th:text="${h.status}">-</a></td>
      </tr>
      </tbody>
    </table>

    <!-- 페이저 -->
    <div class="page-navigation" th:if="${page != null}">
      <div class="pagination">
        <a th:if="${!page.first}"
           th:href="@{/doctor/history(
              doctorId=${cond != null ? cond.doctorId : null},
              fromDate=${cond != null ? cond.fromDate : null},
              toDate=${cond != null ? cond.toDate : null},
              keyword=${cond != null ? cond.keyword : null},
              page=${page.number - 1},
              size=${page.size},
              sort=${sortParam}
           )}">이전</a>

        <!-- 중앙 페이지 번호 (±3 범위) -->
        <a th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
           th:if="${i >= page.number - 3 and i <= page.number + 3}"
           th:href="@{/doctor/history(
              doctorId=${cond != null ? cond.doctorId : null},
              fromDate=${cond != null ? cond.fromDate : null},
              toDate=${cond != null ? cond.toDate : null},
              keyword=${cond != null ? cond.keyword : null},
              page=${i},
              size=${page.size},
              sort=${sortParam}
           )}"
           th:text="${i + 1}"
           th:classappend="${i == page.number} ? ' active-page' : ''"></a>

        <a th:if="${!page.last}"
           th:href="@{/doctor/history(
              doctorId=${cond != null ? cond.doctorId : null},
              fromDate=${cond != null ? cond.fromDate : null},
              toDate=${cond != null ? cond.toDate : null},
              keyword=${cond != null ? cond.keyword : null},
              page=${page.number + 1},
              size=${page.size},
              sort=${sortParam}
           )}">다음</a>
      </div>

      <!-- 우측 버튼 영역 -->
      <div class="create">
        <a th:href="@{/doctor}" class="button-link">메인으로</a>
      </div>
    </div>
  </th:block>
</div>
</html>
