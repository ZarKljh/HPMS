<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>의사 수정 (메인+디테일)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    fieldset { border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:16px; }
    legend { padding:0 8px; color:#333; font-weight:600; }
    .grid { display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; }
    .btn { padding:8px 12px; border:1px solid #aaa; border-radius:6px; text-decoration:none; color:#333; }
    .row { display:flex; gap:8px; align-items:center; margin-top:12px; }
    .err { color:#c00; font-size:12px; grid-column: 1 / span 2; }
    input, select { padding:6px; }
  </style>
</head>
<body>

<div class="row">
  <a class="btn" th:href="@{/doctor/detail(id=${doctorId})}">← 상세</a>
  <h2>의사 수정 (메인 + 디테일)</h2>
</div>

<!-- 메인 저장 폼 (단일 폼만 존재) -->
<form th:action="@{/doctor/edit/{id}(id=${doctorId})}" method="post" th:object="${mForm}">
  <!-- 메인 정보 -->
  <fieldset>
    <legend>메인 정보</legend>
    <div class="grid">
      <label>부서</label> <input type="text" th:field="*{department}" maxlength="4" required/>
      <label>진료과</label> <input type="text" th:field="*{medicalDepartment}" maxlength="50"/>

      <label>직급</label> <input type="text" th:field="*{rank}" maxlength="4" required/>
      <label>직책</label> <input type="text" th:field="*{position}" maxlength="4"/>

      <label>이름</label> <input type="text" th:field="*{firstName}" maxlength="50" required/>
      <label>성</label>   <input type="text" th:field="*{lastName}" maxlength="50" required/>
      <label>중간이름</label> <input type="text" th:field="*{middleName}" maxlength="50"/>

      <label>성별</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="radio" th:field="*{gender}" value="M" required> M</label>
        <label><input type="radio" th:field="*{gender}" value="F"> F</label>
      </div>

      <label>생년월일</label> <input type="date" th:field="*{dateOfBirth}" required/>
      <label>전화번호</label> <input type="text" th:field="*{telephone}" maxlength="20" required/>

      <label>입사일</label> <input type="date" th:field="*{hireDate}" required/>

      <label>상태</label> <input type="text" th:field="*{status}" maxlength="3" required/>
      <label>근무형태</label> <input type="text" th:field="*{workType}" maxlength="4" required/>

      <div class="err" th:if="${#fields.hasAnyErrors()}">
        <div th:each="e: ${#fields.errors('*')}" th:text="${e}">에러</div>
      </div>
    </div>
  </fieldset>

  <!-- 디테일 정보 -->
  <fieldset th:object="${dForm}">
    <legend>디테일 정보</legend>
    <input type="hidden" th:field="*{doctorId}"/>

    <div class="grid">
      <label>이미지 URL</label> <input type="text" th:field="*{image}" maxlength="250" required/>
      <label>User ID</label>   <input type="text" th:field="*{userId}" maxlength="20" required/>
      <label>Password (변경 시에만 입력)</label>
      <input type="password" th:field="*{userPassword}" maxlength="100" placeholder="새 비밀번호 입력">
      <label>사무실 전화</label> <input type="text" th:field="*{officeTelephone}" maxlength="20" required/>
      <label>비상연락처</label>  <input type="text" th:field="*{emergencyContact}" maxlength="20"/>

      <label>비상-이름</label> <input type="text" th:field="*{emergencyFirstName}" maxlength="50"/>
      <label>비상-성</label>   <input type="text" th:field="*{emergencyLastName}" maxlength="50"/>
      <label>비상-중간이름</label> <input type="text" th:field="*{emergencyMiddleName}" maxlength="50"/>
      <label>비상-관계</label> <input type="text" th:field="*{emergencyRelation}" maxlength="10"/>
      <label>비상-비고</label> <input type="text" th:field="*{emergencyNote}" maxlength="250"/>

      <label>이메일</label>    <input type="email" th:field="*{email}" maxlength="250"/>
      <!-- doctor_edit.html (또는 new.html) 디테일 주소 영역에 추가/수정) -->
      <label>우편번호</label><input type="text" th:field="*{postcode}" id="postcode" maxlength="10"/>
      <label>주소</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="text" th:field="*{defaultAddress}" id="addr1" maxlength="250"/>
        <button type="button" class="btn" onclick="openRoadPopup()">도로명 검색</button>
      </div>
      <label>상세주소</label>
      <input type="text" th:field="*{detailedAddress}" id="addr2" maxlength="250"/>
      <label>면허번호</label>  <input type="text" th:field="*{registrationNumber}" maxlength="10" required/>
      <label>학력</label>      <input type="text" th:field="*{educationalBackground}" maxlength="100"/>
      <label>외국어</label>    <input type="text" th:field="*{foreignLanguage}" maxlength="250"/>
      <label>기타자격증</label> <input type="text" th:field="*{license}" maxlength="250"/>

      <label>전공과</label>    <input type="text" th:field="*{major}" maxlength="50" required/>
      <label>근무경력</label>  <input type="text" th:field="*{workDependsOnExperience}" maxlength="250"/>
      <label>수상경력</label>  <input type="text" th:field="*{awards}" maxlength="250"/>
      <label>학회활동</label>  <input type="text" th:field="*{societyActivity}" maxlength="250"/>
      <label>학회인증</label>  <input type="text" th:field="*{certificateOfSociety}" maxlength="250"/>

      <label>병역</label>      <input type="text" th:field="*{militaryService}" maxlength="10"/>
      <input type="hidden" th:field="*{nationality}" />
      <label>국적</label>
      <div>
        <span id="nationalityDisplay" th:text="*{nationality} ?: '-'">-</span>
        <button type="button" class="btn" style="margin-left:8px;" onclick="openCountryPopup()">국적 검색</button>
      </div>

      <label>장애 여부</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="radio" th:field="*{disabilityStatus}" value="Y" required> Y</label>
        <label><input type="radio" th:field="*{disabilityStatus}" value="N"> N</label>
      </div>
      <div class="err" th:if="${#fields.hasErrors('disabilityStatus')}" th:errors="*{disabilityStatus}"></div>

      <label>비고</label>
      <input type="text" th:field="*{note}" maxlength="255"/>

      <div class="err" th:if="${#fields.hasAnyErrors()}">
        <div th:each="e: ${#fields.errors('*')}" th:text="${e}">에러</div>
      </div>
    </div>
  </fieldset>

  <div class="row" style="justify-content:flex-end;">
    <button class="btn" type="submit">수정 저장</button>
  </div>
</form>

<!-- ✅ 국적 자동저장용 폼을 메인 폼 '바깥'에 둔다 -->
<!-- 숨김 폼 -->
<form id="nationalityForm"
      th:action="@{/doctor/{id}/nationality(id=${doctorId})}"
      method="post"
      target="hiddenFrame"
style="display:none;">
<input type="hidden" name="iso2" id="nationalityCodeInput"/>
<input type="hidden" name="countryKr" id="nationalityNameInput"/>
  <!-- CSRF 사용 시 추가
   <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
   -->
</form>

<!-- 👇 이 iframe을 바로 밑에 두면 안전 -->
<iframe name="hiddenFrame" style="display:none;"></iframe>


<script>
  function openCountryPopup() {
    const w = 780, h = 620;
    const left = (screen.width - w) / 2;
    const top = (screen.height - h) / 2;
    // 팝업 URL은 사용 중인 컨트롤러 경로에 맞춰 통일
    window.open('/global/road/popup', 'countryPopup',
      `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
  }


  function setCountry(iso2, countryKr) {
  const disp = document.getElementById('nationalityDisplay');
  if (disp) disp.textContent = `${countryKr} (${iso2})`;

  // 숨김 입력에도 값을 채워서 메인 폼 submit 시 유지되도록
  const hiddenNationality = document.querySelector('input[name="nationality"]');
  if (hiddenNationality) hiddenNationality.value = `${countryKr} (${iso2})`;

  // (별도 저장을 계속 쓰신다면) iframe 타겟 폼 제출은 그대로
  document.getElementById('nationalityCodeInput').value = iso2;
  document.getElementById('nationalityNameInput').value = countryKr;
  document.getElementById('nationalityForm').submit();
}

  function openRoadPopup() {
    const w = 900, h = 640;
    const left = (screen.width - w)/2, top = (screen.height - h)/2;
    window.open('/global/road_name_form', 'roadPopup',
      `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
  }

  // 팝업에서 호출: 값만 채움 (저장은 최종 "수정 저장"에서 함께)
  function setRoad(addrStr, roadCode, emdSeqNo) {
    // 기본주소에 도로명 기반 주소를 채우고, 상세주소는 사용자가 이어서 입력
    document.getElementById('addr1').value = addrStr || '';
    // 필요하면 숨김 필드로 roadCode/emdSeqNo 따로 보관 가능
    // 예: <input type="hidden" name="roadCode" id="roadCodeHidden"> 등을 미리 만들어 두고 값만 주입
    // document.getElementById('roadCodeHidden').value = roadCode || '';
    // document.getElementById('emdSeqHidden').value  = emdSeqNo || '';
  }
</script>

</body>
</html>
