<html lang="kr" layout:decorate="~{patient/patient_layout}">
<div layout:fragment="content" class="container">
    <h2 class="listbox">Patient List</h2>

    <!-- 🔍 검색 영역 시작 -->
    <div class="search-section container my-3">
        <button type="button" class="btn btn-primary mb-3" onclick="toggleSearchForm()">검색하기</button>

        <form id="searchForm" method="get" action="/patient/search" class="card p-3" style="display:none;">
            <div id="searchConditions">
                <!-- 🔹 검색 조건 한 줄 -->
                <div class="search-row row mb-2">
                    <div class="col-md-3">
                        <select name="column[]" class="form-select" onchange="updateOperatorOptions(this)">
                            <option value="">컬럼 선택</option>
                            <option value="lastName">성명 성</option>
                            <option value="firstName">성명 이름</option>
                            <option value="gender">성별</option>
                            <option value="birth">생년월일</option>
                            <option value="foreigner">내/외국인</option>
                            <option value="mobilePhone">휴대전화(뒷4자리)</option>
                            <option value="guardianTel">보호자전화(뒷4자리)</option>
                            <option value="createDate">최초등록일</option>
                            <option value="lastVisitDate">최종방문일</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <select name="operator[]" class="form-select">
                            <option value="=">=</option>
                            <option value="like">포함</option>
                            <option value=">">></option>
                            <option value="<"><</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <input type="text" name="value[]" class="form-control" placeholder="값 입력">
                    </div>

                    <div class="col-md-2">
                        <select name="logicalOperator[]" class="form-select">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <button type="button" class="btn btn-success" onclick="addConditionRow()">+</button>
                        <button type="button" class="btn btn-danger" onclick="removeConditionRow(this)">-</button>
                    </div>
                </div>
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-primary">검색 실행</button>
            </div>
        </form>
    </div>
    <!-- 🔍 검색 영역 끝 -->


    <form method="get" action="/patient/list">
        <label for="size">Row counter:</label>
        <select name="size" id="size" onchange="this.form.page.value='0'; this.form.submit();">
            <option th:value="5" th:selected="${size == 5}">5</option>
            <option th:value="10" th:selected="${size == 10}">10</option>
            <option th:value="20" th:selected="${size == 20}">20</option>
        </select>
        <input type="hidden" name="page" value="${currentPage}" />
    </form>
    <div class="patient-list"> <!-- 환자리스트 시작-->
        <table class="table table-hover card">
            <thead class="table-info">
            <tr class="list text-center">

                <th class="mobail_hidden">환자ID</th>
                <th>성명</th>
                <th>성별</th>
                <th>생년월일</th>
                <th  class="mobail_hidden">내/외국인</th>
                <th>휴대전화</th>
                <th  class="mobail_hidden">보호자 연락처</th>
                <th  class="mobail_hidden">최종 방문일</th>
                <th  class="mobail_hidden">등록일</th>
            </tr>
            </thead>

            <tbody class="text-center">
            <tr class="text-center" th:each="patient,  loop : ${patients}">

                <td class="mobail_hidden" th:text="${patient.id}"></td>
                <td>
                    <a th:href="@{|/patient/detail/${patient.id}|}" th:text="${patient.name}"></a>
                </td>
                <td th:text="${patient.gender}"></td>
                <td th:text="${#temporals.format(patient.birth,'yyyy-MM-dd')}"></td>
                <td class="mobail_hidden" th:text="${patient.foreigner == '1' ? '외국인' : '내국인'}"></td>
                <td th:text="${patient.mobilePhone}"></td>
                <td class="mobail_hidden" th:text="${patient.guardianTel}"></td>
                <td class="mobail_hidden" th:text="${#temporals.format(patient.lastVisitDate,'yyyy-MM-dd')}"></td>
                <td class="mobail_hidden" th:text="${#temporals.format(patient.createDate,'yyyy-MM-dd')}"></td>
            </tr>
            </tbody>
        </table>
    </div> <!-- 환자리스트 끝-->
    <div class="footer">
        <div class="page-navigation"><!-- 페이지 이동버튼 시작-->
            <form id="registrationForm" method="post" action="/user/personnel_registration">
                <input name="size" type="hidden" th:value="${size}" >
                <!--<input name="page" type="text" th:value="${page}" hidden="hidden">-->
                <input type="hidden" name="page" th:value="${currentPage}" />
                <a th:href="@{/patient/create}" class="button-link text-full">
                    등록하기
                </a>
                <a href="#" class="button-link delete-button">
                    삭제하기
                </a>
            </form>
        </div><!-- 페이지 이동버튼 끝-->

        <!-- 페이징처리 시작 -->
        <div class="page" th:if="${!patients.isEmpty()}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${!patients.hasPrevious} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{|?page=${patients.number-1}|}">
                        <span>이전</span>
                    </a>
                </li>
                <li th:each="page: ${#numbers.sequence(0, patients.totalPages-1)}"
                    th:if="${page >= patients.number-5 and page <= patients.number+5}"
                    th:classappend="${page == patients.number} ? 'active'"
                    class="page-item">
                    <a th:text="${page}" class="page-link" th:href="@{|?page=${page}|}"></a>
                </li>
                <li class="page-item" th:classappend="${!patients.hasNext} ? 'disabled'">
                    <a class="page-link" th:href="@{|?page=${patients.number+1}|}">
                        <span>다음</span>
                    </a>
                </li>
            </ul>
        </div>
        <!-- 페이징처리 끝 -->
    </div>

</div>
<!-- ✅ JS 스크립트: 검색 폼 동적 제어 -->

</html>
