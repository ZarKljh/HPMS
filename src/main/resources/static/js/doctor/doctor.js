   // ‚úÖ ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÌÖåÏù¥Î∏îÏùò Ï≤¥ÌÅ¨Î∞ïÏä§Îßå ÎåÄÏÉÅÏúºÎ°ú Ï†úÌïú
   const $selectAll = document.getElementById('selectAll');
   const itemSelector = 'tbody input[type="checkbox"][name="ids"]';
   const getItems = () => document.querySelectorAll(itemSelector);

   function setAll(checked) { getItems().forEach(cb => cb.checked = checked); }

   function syncMaster() {
     const items = getItems();
     const total = items.length;
     const checked = [...items].filter(cb => cb.checked).length;
     $selectAll.checked = (total > 0 && checked === total);
     $selectAll.indeterminate = (checked > 0 && checked < total); // Î∂ÄÎ∂Ñ ÏÑ†ÌÉù ÌëúÏãú
   }

   // ‚úÖ Ï†ÑÏ≤¥ÏÑ†ÌÉù ÌÅ¥Î¶≠ Ïãú: Î∂ÄÎ∂Ñ ÏÑ†ÌÉù ÏÉÅÌÉúÎ©¥ "Ï†ÑÎ∂Ä Ìï¥Ï†ú"Î°ú ÎèôÏûëÌïòÍ≤å
   $selectAll.addEventListener('click', (e) => {
     const items = getItems();
     const total = items.length;
     const checked = [...items].filter(cb => cb.checked).length;

     if ($selectAll.indeterminate || (checked > 0 && checked < total)) {
       // Î∂ÄÎ∂Ñ ÏÑ†ÌÉù ÏÉÅÌÉú ‚Üí Ìïú Î≤àÏóê Ï†ÑÎ∂Ä Ìï¥Ï†ú
       e.preventDefault(); // Í∏∞Î≥∏ ÌÜ†Í∏Ä ÎßâÍ≥† ÏßÅÏ†ë Ï≤òÎ¶¨
       $selectAll.indeterminate = false;
       $selectAll.checked = false;
       setAll(false);
     }
     // Í∑∏ Ïô∏ÏóêÎäî change Ìï∏Îì§Îü¨Í∞Ä Ï≤òÎ¶¨ (Ï†ÑÎ∂Ä ÏÑ†ÌÉù/Ï†ÑÎ∂Ä Ìï¥Ï†ú)
   });

   // ‚úÖ Ï†ÑÏ≤¥ÏÑ†ÌÉù change: Ï≤¥ÌÅ¨ Ïó¨Î∂ÄÎ°ú Ï†ÑÎ∂Ä ÏÑ†ÌÉù/Ìï¥Ï†ú
   $selectAll.addEventListener('change', () => {
     setAll($selectAll.checked);
   });

   // ‚úÖ Í∞úÎ≥Ñ Ï≤¥ÌÅ¨ Î≥ÄÌôîÏóê Îî∞Îùº ÎßàÏä§ÌÑ∞ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
   document.addEventListener('change', (e) => {
     if (e.target.matches(itemSelector)) syncMaster();
   });

   // Ï¥àÍ∏∞ ÎèôÍ∏∞Ìôî
   syncMaster();

   // üëá Í∏∞Ï°¥ Îã§Ï§ëÏÇ≠Ï†ú Î≤ÑÌäº JSÎäî Ïú†ÏßÄÌïòÎêò, ÏÑ†ÌÉùÏûêÎßå Îçî ÏïàÏ†ÑÌïòÍ≤å
   document.getElementById('deleteSelected').addEventListener('click', function() {
     const ids = [...document.querySelectorAll(itemSelector)]
       .filter(cb => cb.checked)
       .map(cb => cb.value);

     if (!ids.length) { alert('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.'); return; }
     if (!confirm(ids.length + 'Í±¥ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

     const form = document.createElement('form');
     form.method = 'post';
     form.action = '/doctor/deleteSelected';

     ids.forEach(id => {
       const input = document.createElement('input');
       input.type = 'hidden';
       input.name = 'ids';
       input.value = id;
       form.appendChild(input);
     });

     // üîê CSRF hidden Ï∂îÍ∞Ä(Î†àÏù¥ÏïÑÏõÉ headÏóê Î©îÌÉÄÍ∞Ä ÏûàÎã§Í≥† Í∞ÄÏ†ï)
     const csrfParam = document.querySelector('meta[name="_csrf_parameter"]').content;
     const csrfToken = document.querySelector('meta[name="_csrf"]').content;
     const csrfInput = document.createElement('input');
     csrfInput.type = 'hidden';
     csrfInput.name = csrfParam;
     csrfInput.value = csrfToken;
     form.appendChild(csrfInput);

     document.body.appendChild(form);
     form.submit();
   });

    // Íµ≠Ï†Å ÌåùÏóÖ Ïó¥Í∏∞
    function openCountryPopup() {
      const w = 780, h = 620;
      const left = (screen.width - w) / 2;
      const top = (screen.height - h) / 2;
      window.open('/global/country_form', 'countryPopup',
        `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
    }

    // Íµ≠Ï†Å ÏÑ†ÌÉù ÏΩúÎ∞± (ÌåùÏóÖÏóêÏÑú window.opener.setCountry Ìò∏Ï∂ú)
    function setCountry(iso2, countryKr) {
      const disp = document.getElementById('nationalityDisplay');
      if (disp) disp.textContent = `${countryKr} (${iso2})`;

      const hidden = document.getElementById('nationalityInput');
      if (hidden) hidden.value = `${countryKr} (${iso2})`;
    }

    // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå ÌåùÏóÖ
    function openRoadPopup() {
      const w = 900, h = 640;
      const left = (screen.width - w) / 2;
      const top = (screen.height - h) / 2;
      window.open('/global/road/popup', 'roadPopup',
        `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
    }

    // ÎèÑÎ°úÎ™Ö ÏÑ†ÌÉù ÏΩúÎ∞±
    function setRoad(addrStr /*, roadCode, emdSeqNo */) {
      const addr = document.getElementById('addr1');
      if (addr) addr.value = addrStr || '';
    }

    // ÏßÅÍ∏â/ÏßÅÏ±Ö ÌåùÏóÖ
    function openJobPopup() {
      const w = 700, h = 520;
      const left = (screen.width - w) / 2;
      const top = (screen.height - h) / 2;
      window.open('/global/jobcode/popup', 'job_code',
        `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
    }

    // ÌåùÏóÖ -> Î≥∏Ï∞Ω Î©îÏãúÏßÄ Ï≤òÎ¶¨
    window.addEventListener('message', (e) => {
      if (e.data?.source !== 'jobcode-popup') return;
      const { rankCode, positionCode } = e.data.payload || {};

      const rankInput = document.getElementById('rank');
      if (rankInput) rankInput.value = rankCode ?? '';

      const positionInput = document.getElementById('position');
      if (positionInput) positionInput.value = positionCode ?? '';
    });

        function choose(iso2, countryKr) {
          if (window.opener && !window.opener.closed && typeof window.opener.setCountry === 'function') {
            window.opener.setCountry(iso2, countryKr);
          }
          window.close();
        }

            function makeOptionText(item) {
              const code = item.code ?? '';
              const kor  = item.korName ?? '';
              const eng  = item.engName ?? '';
              return `[${code}] ${kor} / ${eng}`;
            }
            async function fetchJson(url) {
              const res = await fetch(url);
              if (!res.ok) throw new Error(`${url} ${res.status}`);
              return res.json();
            }

            // ÏßÅÏ±Ö(ÏÑ†ÌÉù)
            fetchJson('/global/jobcode/positions')
              .then(list => {
                const sel = document.getElementById('positionSelect');
                sel.innerHTML = '';
                (list || []).forEach(item => {
                  const opt = document.createElement('option');
                  // Î∂ÄÎ™®Î°úÎäî ÌïúÍµ≠Ïñ¥Î™Ö Ï†ÑÎã¨ (VARCHAR(4) ÎåÄÏùë)
                  opt.value = item.korName;
                  opt.dataset.kor = item.korName;
                  opt.textContent = makeOptionText(item);
                  sel.appendChild(opt);
                });
              })
              .catch(err => console.warn('ÏßÅÏ±Ö Î°úÎìú Ïã§Ìå®:', err));

            // ÏßÅÍ∏â(ÏÑ†ÌÉù)
            fetchJson('/global/jobcode/ranks')
              .then(list => {
                const sel = document.getElementById('rankSelect');
                sel.innerHTML = '';
                (list || []).forEach(item => {
                  const opt = document.createElement('option');
                  opt.value = item.korName;
                  opt.dataset.kor = item.korName;
                  opt.textContent = makeOptionText(item);
                  sel.appendChild(opt);
                });
              })
              .catch(err => console.warn('ÏßÅÍ∏â Î°úÎìú Ïã§Ìå®:', err));

            function applySelection() {
              const rankOpt = document.getElementById('rankSelect').selectedOptions[0];
              const posOpt  = document.getElementById('positionSelect').selectedOptions[0];

              // ÏÑ†ÌÉù Ïïà ÌñàÏúºÎ©¥ Îπà Î¨∏ÏûêÏó¥Î°ú Ï†ÑÎã¨
              const rankKor     = rankOpt ? (rankOpt.dataset.kor || rankOpt.value) : '';
              const positionKor = posOpt  ? (posOpt.dataset.kor  || posOpt.value)  : '';

              window.opener?.postMessage({
                source: 'jobcode-popup',
                payload: { rankCode: rankKor, positionCode: positionKor }
              }, '*');

              window.close();
            }

                let currentPage = 0, totalPages = 0, prevPage = 0, nextPage = 0, pageSize = 10;


                function load(page) {
                  const kw = document.getElementById('kw').value || '';
                  fetch(`/global/road/search?kw=${encodeURIComponent(kw)}&page=${page}&size=${pageSize}`)
                    .then(r => r.json())
                    .then(data => {
                      currentPage = data.number;
                      totalPages  = data.totalPages;
                      prevPage = Math.max(0, currentPage - 1);
                      nextPage = Math.min(totalPages - 1, currentPage + 1);

                      document.getElementById('prev').disabled = currentPage === 0;
                      document.getElementById('next').disabled = currentPage >= totalPages - 1 || totalPages === 0;
                      document.getElementById('pageInfo').textContent = `${totalPages ? (currentPage+1) : 0}/${totalPages}`;

                      const tbody = document.getElementById('rows');
                      tbody.innerHTML = '';
                      if (data.content.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>`;
                        return;
                      }
                      data.content.forEach(a => {
                        const addrStr = [a.sido_kor, a.sgg_kor, a.emd_kor, a.road_name_kor]
                                         .filter(Boolean).join(' ');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                          <td>${a.sido_kor ?? ''}</td>
                          <td>${a.sgg_kor ?? ''}</td>
                          <td>${a.emd_kor ?? ''}</td>
                          <td>${a.road_name_kor ?? ''}</td>
                          <td>${a.road_code ?? ''}</td>
                          <td><button type="button">ÏÑ†ÌÉù</button></td>`;
                        tr.ondblclick = () => choose(addrStr, a);
                        tr.querySelector('button').onclick = () => choose(addrStr, a);
                        tbody.appendChild(tr);
                      });
                    })
                    .catch(e => {
                      alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                      console.error(e);
                    });
                }

                function go(p) { load(p); }

                function choose(addrStr, a) {
                  if (window.opener && !window.opener.closed) {
                    // Î∂ÄÎ™®Ïóê Í∞íÎßå Ï†ÑÎã¨ (Î∂ÄÎ™®Í∞Ä Ï†ÄÏû• Ïó¨Î∂Ä Í≤∞Ï†ï)
                    window.opener.setRoad(addrStr, a.road_code || '', a.emd_seq_no || '');
                  }
                  window.close();
                }

    // Ï†ÑÏó≠ ÏÇ¨Ïö©ÏùÑ ÏúÑÌï¥ ÎÖ∏Ï∂ú
    window.openCountryPopup = openCountryPopup;
    window.setCountry = setCountry;
    window.openRoadPopup = openRoadPopup;
    window.setRoad = setRoad;
    window.openJobPopup = openJobPopup;

